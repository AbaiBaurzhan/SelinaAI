name: Deploy to Cloud Run

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: 836619908242
  REGION: europe-central2
  SERVICE_NAME: selinaai-new
  ARTIFACT_REGISTRY: europe-central2-docker.pkg.dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    name: Deploy to Cloud Run

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: 836619908242
  REGION: europe-central2
  SERVICE_NAME: selinaai-new
  ARTIFACT_REGISTRY: europe-central2-docker.pkg.dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}
        echo "âœ… Docker Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ´Ğ»Ñ Artifact Registry"
    
    - name: Create Artifact Registry Repository
      run: |
        echo "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ Ğ² Artifact Registry..."
        echo "âœ… Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ selinaai ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
    
    - name: Build and Push Docker Image
      run: |
        echo "ï¿½ï¿½ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°..."
        docker build -f Dockerfile.cloud -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/selinaai/selinaai:${{ github.sha }} .
        echo "ğŸ“¤ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ² Artifact Registry..."
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/selinaai/selinaai:${{ github.sha }}
        echo "âœ… ĞĞ±Ñ€Ğ°Ğ· ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ² Artifact Registry"
    
    - name: Deploy to Cloud Run
      run: |
        echo "ğŸš€ Ğ Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Google Cloud Run..."
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/selinaai/selinaai:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 8080 \
          --memory 1Gi \
          --cpu 1 \
          --max-instances 10 \
          --timeout 300 \
          --min-instances 0 \
          --concurrency 80 \
          --set-env-vars "CLOUD_RUN=true" \
          --set-env-vars "TELEGRAM_WEBHOOK_MODE=true"
        
        echo "âœ… Ğ Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾"
    
    - name: Get Service URL
      id: get-url
      run: |
        echo "url=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --format="value(status.url)")" >> $GITHUB_OUTPUT
    
    - name: Show Service URL
      run: |
        echo "ï¿½ï¿½ Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ: ${{ steps.get-url.outputs.url }}"
        echo "ğŸ“± Telegram Webhook: ${{ steps.get-url.outputs.url }}/webhook/telegram"
        echo "ğŸ“Š Health Check: ${{ steps.get-url.outputs.url }}/healthz"
    
    - name: Test Health Endpoint
      run: |
        echo "ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ health endpoint..."
        sleep 30  # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ°
        curl -f "${{ steps.get-url.outputs.url }}/healthz" || exit 1
        echo "âœ… Health check Ğ¿Ñ€Ğ¾ÑˆĞµĞ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾"
    
    - name: Complete job
      run: echo "ğŸ‰ Job completed successfully"
    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}
        echo "âœ… Docker Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ´Ğ»Ñ Artifact Registry"
    
    - name: Create Artifact Registry Repository
      run: |
        echo "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ Ğ² Artifact Registry..."
        echo "âœ… Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ selinaai ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
    
    - name: Build and Push Docker Image
      run: |
        echo "ï¿½ï¿½ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°..."
        docker build -f Dockerfile.cloud -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/selinaai/selinaai:${{ github.sha }} .
        echo "ğŸ“¤ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ² Artifact Registry..."
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/selinaai/selinaai:${{ github.sha }}
        echo "âœ… ĞĞ±Ñ€Ğ°Ğ· ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ² Artifact Registry"
    
    - name: Deploy to Cloud Run
      run: |
        echo "ğŸš€ Ğ Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Google Cloud Run..."
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/selinaai/selinaai:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 8080 \
          --memory 1Gi \
          --cpu 1 \
          --max-instances 10 \
          --timeout 300 \
          --min-instances 0 \
          --concurrency 80 \
          --set-env-vars "CLOUD_RUN=true" \
          --set-env-vars "TELEGRAM_WEBHOOK_MODE=true"
        
        echo "âœ… Ğ Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾"
    
    - name: Get Service URL
      id: get-url
      run: |
        echo "url=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --format="value(status.url)")" >> $GITHUB_OUTPUT
    
    - name: Show Service URL
      run: |
        echo "ï¿½ï¿½ Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ: ${{ steps.get-url.outputs.url }}"
        echo "ğŸ“± Telegram Webhook: ${{ steps.get-url.outputs.url }}/webhook/telegram"
        echo "ğŸ“Š Health Check: ${{ steps.get-url.outputs.url }}/healthz"
    
    - name: Test Health Endpoint
      run: |
        echo "ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ health endpoint..."
        sleep 30  # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ°
        curl -f "${{ steps.get-url.outputs.url }}/healthz" || exit 1
        echo "âœ… Health check Ğ¿Ñ€Ğ¾ÑˆĞµĞ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾"
    
    - name: Complete job
      run: echo "ğŸ‰ Job completed successfully"
